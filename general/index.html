<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA Scramble Statistics</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <h1><a id="event-header" href="../">General</a></h1>
    <select id="csv-selector" onchange="updateSubOptions()">
        
        <option value="Scramble_Counts">Scramble Counts</option>
        
        <option value="Weird_Groups">Weird Groups</option>
        
    </select>

    <!-- Secondary Dropdown for Subcategories -->
    <select id="sub-csv-selector" onchange="displaySelectedCSV()">
        <!-- This will be dynamically populated -->
    </select>

    <div id="csv-data"></div>

    <script>
        const csvFiles = {
            
            'Scramble_Counts': ['Scramble_Counts/Fewest_MBLD_Scrambles_for_One_Attempt.csv', 'Scramble_Counts/Most_Extras_in_a_Single_Group.csv', 'Scramble_Counts/Most_MBLD_Scrambles_for_One_Attempt.csv', 'Scramble_Counts/Most_Scrambles_at_a_Single_Competition.csv', 'Scramble_Counts/Most_Scrambles_in_a_Single_Group.csv'],
            
            'Weird_Groups': ['Weird_Groups/Ao5_Events_(Counting_Extras).csv', 'Weird_Groups/Ao5_Events_(Not_Counting_Extras).csv', 'Weird_Groups/Mo3_Events_(Counting_Extras).csv', 'Weird_Groups/Mo3_Events_(Not_Counting_Extras).csv'],
            
        };

        const subCategoryNames = {
            
            'Scramble_Counts/Fewest_MBLD_Scrambles_for_One_Attempt.csv': 'Fewest MBLD Scrambles for One Attempt',
            
            'Scramble_Counts/Most_Extras_in_a_Single_Group.csv': 'Most Extras in a Single Group',
            
            'Scramble_Counts/Most_MBLD_Scrambles_for_One_Attempt.csv': 'Most MBLD Scrambles for One Attempt',
            
            'Scramble_Counts/Most_Scrambles_at_a_Single_Competition.csv': 'Most Scrambles at a Single Competition',
            
            'Scramble_Counts/Most_Scrambles_in_a_Single_Group.csv': 'Most Scrambles in a Single Group',
            
            'Weird_Groups/Ao5_Events_(Counting_Extras).csv': 'Ao5 Events (Counting Extras)',
            
            'Weird_Groups/Ao5_Events_(Not_Counting_Extras).csv': 'Ao5 Events (Not Counting Extras)',
            
            'Weird_Groups/Mo3_Events_(Counting_Extras).csv': 'Mo3 Events (Counting Extras)',
            
            'Weird_Groups/Mo3_Events_(Not_Counting_Extras).csv': 'Mo3 Events (Not Counting Extras)',
            
        };

        function updateSubOptions() {
            const primaryCategory = document.getElementById('csv-selector').value;
            const subCsvSelector = document.getElementById('sub-csv-selector');

            // Clear existing options
            subCsvSelector.innerHTML = '';

            // Populate with new subcategory options
            csvFiles[primaryCategory].forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = subCategoryNames[file];
                subCsvSelector.appendChild(option);
            });

            // Automatically display the first subcategory's CSV
            displayCSV(csvFiles[primaryCategory][0]);
        }

        function displayCSV(filename) {
            Papa.parse(filename, {
                download: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data; // PapaParse gives us an array of arrays
                    if (rows.length === 0) return;

                    let rowspans = [];
                    let colTracker = [];
                    const numCols = rows[0].length;

                    // Initialize tracking arrays
                    rows.forEach((_, rowIndex) => {
                        rowspans[rowIndex] = new Array(numCols).fill(1);
                    });
                    colTracker = new Array(numCols).fill(1);

                    // LOOP 1: Calculate Rowspans
                    // We start from index 1 (second row) to compare with the one above
                    for (let i = 1; i < rows.length; i++) {
                        let canCombine = true;

                        for (let j = 0; j < numCols; j++) {
                            // Check if current cell matches cell above AND the previous column also merged
                            if (canCombine && rows[i][j] === rows[i - 1][j]) {
                                colTracker[j]++;
                                // Update the 'root' cell (the one that stays visible) with the new span count
                                rowspans[i - colTracker[j] + 1][j] = colTracker[j];
                                // Mark current cell as 0 so we know to skip it in the HTML loop
                                rowspans[i][j] = 0; 
                            } else {
                                colTracker[j] = 1;
                                canCombine = false; // Break the horizontal "combine" chain
                            }
                        }
                    }

                    // LOOP 2: Generate HTML
                    let table = '<table>';
                    rows.forEach((row, rowIndex) => {
                        table += '<tr>';
                        row.forEach((col, colIndex) => {
                            const span = rowspans[rowIndex][colIndex];

                            if (rowIndex === 0) {
                                // Header Row
                                table += `<th>${col}</th>`;
                            } else {
                                // Only create a <td> if its rowspan is > 0
                                if (span > 0) {
                                    table += `<td rowspan="${span}">${col}</td>`;
                                }
                            }
                        });
                        table += '</tr>';
                    });
                    table += '</table>';

                    document.getElementById('csv-data').innerHTML = table;
                }
            });
        }

        function displaySelectedCSV() {
            const selectedFile = document.getElementById('sub-csv-selector').value;
            displayCSV(selectedFile);
        }

        // Initialize with the first primary category
        updateSubOptions();
    </script>

    <a href="../">Back to main page</a>
</body>
</html>